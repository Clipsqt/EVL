    <?php
    $api_url = "http://worldtimeapi.org/api/ip";
    $ch = curl_init($api_url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    $response = curl_exec($ch);

    if (curl_errno($ch)) {
        echo "Error: " . curl_error($ch);
        exit;
    }

    curl_close($ch);

    $data = json_decode($response, true);

    if ($data !== null && isset($data['datetime'])) {
        $currentDate = new DateTime($data['datetime']);
        $formattedDate = $currentDate->format('m-d-Y');
        $scheduledate = $currentDate->format('m/d/Y');
        session_start();
        require_once("connect.php"); // Make sure this file includes database connection code.
        $query = "SELECT * FROM e_monitoringlogsheet WHERE scheduledate = ?";
        $stmt = mysqli_prepare($conn, $query);

        if ($stmt) {
            mysqli_stmt_bind_param($stmt, "s", $scheduledate);
            mysqli_stmt_execute($stmt);
            $result = mysqli_stmt_get_result($stmt);
            $rowNumber = 1;
        } else {
            echo "Failed to prepare the statement.";
        }
    } else {
        echo "Failed to fetch data from the API.";
    }

    $filterFullName = '';
    $filterDepartment = '';

    if (isset($_GET['filterFullName'])) {
        $filterFullName = mysqli_real_escape_string($conn, $_GET['filterFullName']);
    }

    if (isset($_GET['filterDepartment'])) {
        $filterDepartment = mysqli_real_escape_string($conn, $_GET['filterDepartment']);
    }

    $query = "SELECT * FROM e_monitoringlogsheet WHERE scheduledate = ?";

    if (!empty($filterFullName)) {
        $query .= " AND fullname LIKE ?";
    }

    if (!empty($filterDepartment)) {
        $query .= " AND department LIKE ?";
    }

    $stmt = mysqli_prepare($conn, $query);

    if ($stmt) {
        if (!empty($filterFullName)) {
            $filterFullName = "%" . $filterFullName . "%";
            mysqli_stmt_bind_param($stmt, "ss", $scheduledate, $filterFullName);
        } elseif (!empty($filterDepartment)) {
            $filterDepartment = "%" . $filterDepartment . "%";
            mysqli_stmt_bind_param($stmt, "ss", $scheduledate, $filterDepartment);
        } else {
            mysqli_stmt_bind_param($stmt, "s", $scheduledate);
        }

        mysqli_stmt_execute($stmt);
        $result = mysqli_stmt_get_result($stmt);
    }

    $rowNumber = 1;
    ?>
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Bookman+Old+Style">
        <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
        <link rel="stylesheet" href="e_monitoringLogsheet.css">
        <title>Monitoring Visitor's Logbook</title>
    </head>
    <body>

    <header>
        <img src="monitoring logbook logo.jpeg.png" alt="">
        <h1>  E- MONITORING LOG SHEET</h1>
        <input type="text" id="search" placeholder="Search">
    </div>
    </header>
    <div class="scroll-container">
        <div class="scroll"></div>
        <table id="monitoringTable">
            <thead>
            <tr>
            <th id="colNo">No.</th>
                <th id="colFullName">Full Name</th>
                <th id="colSex">Sex</th>
                <th id="colPriority">Priority</th>
                <th id="colPhoneNumber">Phone Number</th>
                <th id="colScheduleDate">Schedule Date</th>
                <th id="colAppointment">Appointment</th>
                <th id="colPurpose">Purpose of visit</th>
                <th id="colDepartment">Department</th>
                <th id="colReference_no">Reference No.</th>
                <th id="colTime_in">Time In</th>
                <th id="colTime_out">Time out </th>
                <th id="colAction">Action</th> 
                
            <?php

            while ($row = mysqli_fetch_assoc($result)) {
                ?>
                <tr>
                <td><?php echo $rowNumber; ?></td>
                
            <td class="fullname"><?php echo $row["fullname"]; ?></td>
            <td class="sex"><?php echo $row["sex"]; ?></td>
            <td class="priority"><?php echo $row["priority"]; ?></td>
            <td><?php echo $row["phonenumber"]; ?></td>
            <td class="sched"><?php echo $row["scheduledate"]; ?></td>
            <td><?php echo $row["appointment"]; ?></td>
            <td><?php echo $row["purpose_of_visit"]; ?></td>
            <td><?php echo $row["department"]; ?></td>
            <td><?php echo $row["reference_no"]; ?></td> 
            <td class="time-in"></td>
            <td><?php echo $row["time_out"]; ?></td>
            
            
            <td class="time-in">
            <?php
            if ($row["appointment"] == "Online") {
                // For online appointments, show a button to log the time in
                echo '<button class="time-in-button">Time In</button>';
            }   
            
    ?>   
</td>
    </td>
        </tr>
        <?php
        $rowNumber++;
            }
            ?>
        </table>
        </div> 
    </div>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        const searchInput = document.getElementById("search");
        const table = document.getElementById("monitoringTable");
        const rows = table.querySelectorAll("tbody tr");

        function filterRows() {
            const searchTerm = searchInput.value.trim().toLowerCase();

            rows.forEach(function(row) {
                let rowMatch = false;

                row.querySelectorAll("td").forEach(function(cell) {
                    const cellValue = cell.textContent.trim().toLowerCase();
                    if (cellValue.includes(searchTerm)) {
                        rowMatch = true;
                    }
                });

                // Check if the row matches the search term or if no search term is provided (show all rows)
                if (searchTerm === "" || rowMatch) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });
        }

        searchInput.addEventListener("input", filterRows);
    });
    </script>
    <script>
    document.addEventListener("DOMContentLoaded", function () {
        function sortTable(columnIndex, ascending) {
                let table, rows, switching, i, x, y, shouldSwitch;
                table = document.getElementById("monitoringTable");
                switching = true;
                while (switching) {
                    switching = false;
                    rows = table.rows;
                    for (i = 1; i < (rows.length - 1); i++) {
                        shouldSwitch = false;
                        x = rows[i].getElementsByTagName("td")[columnIndex];
                        y = rows[i + 1].getElementsByTagName("td")[columnIndex];
                        if (ascending) {
                            if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                                shouldSwitch = true;
                                break;
                            }
                        } else {
                            if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                                shouldSwitch = true;
                                break;
                            }
                        }
                    }
                    if (shouldSwitch) {
                        rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                        switching = true;
                    }
                }
            }
            
            
            document.getElementById("colNo").addEventListener("click", function () {
                sortTable(0, true);
            });
            document.getElementById("colFullName").addEventListener("click", function () {
                sortTable(1, true);
            });
            document.getElementById("colSex").addEventListener("click", function () {
                sortTable(2, true);
            });
            document.getElementById("colPriority").addEventListener("click", function () {
                sortTable(3, true);
            });
            document.getElementById("colPhoneNumber").addEventListener("click", function () {
                sortTable(4, true);
            });
            document.getElementById("colScheduleDate").addEventListener("click", function () {
                sortTable(5, true);
            });
            document.getElementById("colAppointment").addEventListener("click", function () {
                sortTable(6, true);
            });
            document.getElementById("colPurpose").addEventListener("click", function () {
                sortTable(7, true);
            });
            document.getElementById("colDepartment").addEventListener("click", function () {
                sortTable(8, true);
            });
            document.getElementById("colReference_no").addEventListener("click", function () {
                sortTable(9, true);
            });
            document.getElementById("colTime_in").addEventListener("click", function () {
                sortTable(10, true);
            });
        
        });
    </script>
    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const timeInButtons = document.querySelectorAll(".time-in-button");

        timeInButtons.forEach(function (button) {
            button.addEventListener("click", function () {
                const row = this.closest("tr"); // Get the parent row of the clicked button
                const timeInCell = row.querySelector(".time-in"); // Get the "Time In" cell
                const currentTime = new Date().toLocaleTimeString(); // Get the current time

                // Update the "Time In" cell with the current time
                timeInCell.textContent = currentTime;

                // Store the current time in local storage
                localStorage.setItem("time_in", currentTime);

                // Send an AJAX request to update the database
                const scheduledate = row.querySelector(".sched").textContent;
                const fullname = row.querySelector(".fullname").textContent;
                updateDatabase(scheduledate, fullname, currentTime);
                
                // Disable the button
                button.classList.add("disabled"); // Add the "disabled" class
                button.disabled = true; // Disable the button element

                // Remove the click event listener to prevent further clicks
                button.removeEventListener("click", clickHandler);
            });
        });

        // Get the stored time from local storage and display it
    const storedTime = localStorage.getItem("time_in");
        if (storedTime) {
            const timeInButtons = document.querySelectorAll(".time-in-button");
            timeInButtons.forEach(function (button) {
                const row = button.closest("tr"); // Get the parent row of the button
                const appointmentType = row.querySelector(".appointment").textContent;

                // Check if the appointment type is "Walk-in" before updating the "Time In" field
                if (appointmentType === "Walk-in") {
                    const timeInCell = row.querySelector(".time-in"); // Get the "Time In" cell
                    timeInCell.textContent = storedTime;
                }
            });
        }

        function updateDatabase(scheduledate, fullname, timeIn) {
            const xhr = new XMLHttpRequest();
            xhr.open("POST", "update_time_in.php", true);
            xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    // Handle the response from the server if needed
                }
            };
            const data = `scheduledate=${scheduledate}&fullname=${fullname}&time_in=${timeIn}`;
            xhr.send(data);
        }
    });
    </script>
    
    </body>
    </html>